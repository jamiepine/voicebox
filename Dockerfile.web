# Stage 1: Build the web frontend
FROM oven/bun:1 AS build

WORKDIR /app

# Copy workspace root config
COPY package.json bun.lock ./

# Copy the workspaces needed for the build
COPY app/ app/
COPY web/ web/

# Create stub package.json for workspaces we don't need but bun requires
RUN mkdir -p tauri && echo '{"name":"@voicebox/tauri","version":"0.0.0","private":true}' > tauri/package.json
RUN mkdir -p landing && echo '{"name":"@voicebox/landing","version":"0.0.0","private":true}' > landing/package.json

# Install dependencies
RUN bun install

# Build the web frontend (skip tsc type checking â€” Vite transpiles independently)
RUN cd web && bunx vite build

# Stage 2: Serve with Nginx
FROM nginx:stable-alpine

# Copy built assets
COPY --from=build /app/web/dist /usr/share/nginx/html

# Copy Nginx config and entrypoint
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf
COPY docker/web-entrypoint.sh /docker-entrypoint.d/40-backend-url.sh
RUN chmod +x /docker-entrypoint.d/40-backend-url.sh

EXPOSE 3000
